<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Confessions</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      padding: 20px;
    }

    .confession {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    .confession h3 {
      margin-top: 0;
    }

    .actions {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .actions span {
      cursor: pointer;
      user-select: none;
      font-size: 18px;
    }

    .like-btn.liked {
      color: red;
    }

    .bookmark-btn.bookmarked {
      color: goldenrod;
    }
  </style>
</head>
<body>

  <div id="confessions"></div>

  <script>
    const pendingLikes = {};
    const bookmarks = new Set(JSON.parse(localStorage.getItem('bookmarks') || '[]'));

    function loadConfessions() {
      const confessions = JSON.parse(localStorage.getItem('confessions')) || [];

      const confessionList = confessions.map(confession => {
        const liked = pendingLikes[confession.id] ? 'liked' : '';
        const bookmarked = bookmarks.has(confession.id) ? 'bookmarked' : '';

        return `
          <div class="confession" data-id="${confession.id}">
            <h3>${confession.tag}</h3>
            <p>${confession.content}</p>
            <small>${confession.timestamp}</small>
            <div class="actions">
              <span id="like-icon-${confession.id}" 
                    class="like-btn ${liked}" 
                    onclick="toggleLike('${confession.id}')">‚ù§Ô∏è</span>
              <span id="like-count-${confession.id}">${confession.likeCount || 0}</span>

              <span onclick="commentConfession('${confession.id}')">üí¨</span>

              <span id="bookmark-icon-${confession.id}" 
                    class="bookmark-btn ${bookmarked}" 
                    onclick="toggleBookmark('${confession.id}')">üîñ</span>
            </div>
          </div>
        `;
      }).join('');

      document.getElementById('confessions').innerHTML = confessionList;
    }

    function toggleLike(confessionId) {
      const likeCountEl = document.getElementById(`like-count-${confessionId}`);
      const iconEl = document.getElementById(`like-icon-${confessionId}`);
      let currentCount = parseInt(likeCountEl.textContent);

      if (!pendingLikes[confessionId]) {
        pendingLikes[confessionId] = true;
        likeCountEl.textContent = currentCount + 1;
        iconEl.classList.add('liked');
      } else {
        delete pendingLikes[confessionId];
        likeCountEl.textContent = Math.max(0, currentCount - 1);
        iconEl.classList.remove('liked');
      }
    }

    function toggleBookmark(confessionId) {
      const iconEl = document.getElementById(`bookmark-icon-${confessionId}`);

      if (bookmarks.has(confessionId)) {
        bookmarks.delete(confessionId);
        iconEl.classList.remove('bookmarked');
      } else {
        bookmarks.add(confessionId);
        iconEl.classList.add('bookmarked');
      }

      localStorage.setItem('bookmarks', JSON.stringify([...bookmarks]));
    }

    function commentConfession(confessionId) {
      alert(`Open comment view for confession ID: ${confessionId}`);
      // In future: show comment modal or redirect to comment page
    }

    async function syncLikes() {
      const userUUID = localStorage.getItem('userUUID');
      for (const confessionId in pendingLikes) {
        try {
          await fetch('/api/like', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ confessionId, userUUID })
          });
        } catch (error) {
          console.error("Failed to sync like for:", confessionId);
        }
      }

      Object.keys(pendingLikes).forEach(id => delete pendingLikes[id]);
    }

    loadConfessions();
    setInterval(loadConfessions, 300000); // Refresh every 5 minutes
  </script>

</body>
</html>
